<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon_32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon_16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.2/css/all.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"draapho.github.io","root":"/","images":"/images","scheme":"Mist","version":"8.2.2","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}};
  </script>
<meta name="description" content="如题.">
<meta property="og:type" content="article">
<meta property="og:title" content="驱动之触摸屏驱动框架和实现">
<meta property="og:url" content="https://draapho.github.io/2018/01/11/1806-drv-ts/index.html">
<meta property="og:site_name" content="DRA&amp;PHO">
<meta property="og:description" content="如题.">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://draapho.github.io/images/1806/ts.png">
<meta property="article:published_time" content="2018-01-10T13:00:00.000Z">
<meta property="article:modified_time" content="2023-08-03T15:25:26.000Z">
<meta property="article:author" content="draapho">
<meta property="article:tag" content="embedded linux">
<meta property="article:tag" content="driver">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://draapho.github.io/images/1806/ts.png">


<link rel="canonical" href="https://draapho.github.io/2018/01/11/1806-drv-ts/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>
<title>驱动之触摸屏驱动框架和实现 | DRA&PHO</title>
  




  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">DRA&PHO</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">thinking & logging</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%80%BB%E8%A7%88"><span class="nav-number">1.</span> <span class="nav-text">总览</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%A7%A6%E6%91%B8%E5%B1%8F%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90"><span class="nav-number">2.</span> <span class="nav-text">触摸屏驱动框架分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9E%E9%A1%BEinput%E5%AD%90%E7%B3%BB%E7%BB%9F"><span class="nav-number">2.1.</span> <span class="nav-text">回顾input子系统</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#s3c2410%E7%9A%84%E8%A7%A6%E6%91%B8%E5%B1%8F%E6%A1%86%E6%9E%B6"><span class="nav-number">2.2.</span> <span class="nav-text">s3c2410的触摸屏框架</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E8%A7%A6%E6%91%B8%E5%B1%8F%E9%A9%B1%E5%8A%A8"><span class="nav-number">3.</span> <span class="nav-text">测试触摸屏驱动</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%B9%E6%B3%95%E4%B8%80-hexdump"><span class="nav-number">3.1.</span> <span class="nav-text">方法一 hexdump</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%B9%E6%B3%95%E4%BA%8C-tslib"><span class="nav-number">3.2.</span> <span class="nav-text">方法二 tslib</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%BA%90%E7%A0%81-%E7%AC%AC%E4%B8%80%E7%89%88"><span class="nav-number">4.</span> <span class="nav-text">源码, 第一版</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ts-c"><span class="nav-number">4.1.</span> <span class="nav-text">ts.c</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Makefile"><span class="nav-number">4.2.</span> <span class="nav-text">Makefile</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95"><span class="nav-number">4.3.</span> <span class="nav-text">测试</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%BA%90%E7%A0%81-%E7%AC%AC%E4%BA%8C%E7%89%88"><span class="nav-number">5.</span> <span class="nav-text">源码, 第二版</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ts-c-1"><span class="nav-number">5.1.</span> <span class="nav-text">ts.c</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95-1"><span class="nav-number">5.2.</span> <span class="nav-text">测试</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="draapho"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">draapho</p>
  <div class="site-description" itemprop="description">explore</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">150</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">93</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://draapho.github.io/2018/01/11/1806-drv-ts/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="draapho">
      <meta itemprop="description" content="explore">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="DRA&PHO">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          驱动之触摸屏驱动框架和实现
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-01-11 00:00:00" itemprop="dateCreated datePublished" datetime="2018-01-11T00:00:00+11:00">2018-01-11</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2023-08-04 01:25:26" itemprop="dateModified" datetime="2023-08-04T01:25:26+10:00">2023-08-04</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/embedded-linux/" itemprop="url" rel="index"><span itemprop="name">embedded linux</span></a>
        </span>
    </span>

  
</div>

            <div class="post-description">如题.</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="总览"><a href="#总览" class="headerlink" title="总览"></a>总览</h1><ul>
<li><a href="https://draapho.github.io/2017/11/23/1734-linux-content/">嵌入式linux学习目录</a></li>
<li><a href="https://draapho.github.io/2018/01/05/1802-drv-input/">驱动之input子系统</a></li>
<li><a href="https://draapho.github.io/2018/01/08/1803-drv-platform/">驱动之platform概念</a></li>
<li><a href="https://draapho.github.io/2018/02/08/1814-drv-rtc/">驱动之RTC分析</a></li>
<li><a href="https://draapho.github.io/2018/01/09/1804-drv-lcd/">驱动之LCD驱动框架和实现</a></li>
<li><a href="https://draapho.github.io/2018/01/11/1806-drv-ts/">驱动之触摸屏驱动框架和实现</a></li>
<li><a href="https://draapho.github.io/2018/01/18/1807-drv-usb1/">驱动之USB基础概念和框架</a></li>
<li><a href="https://draapho.github.io/2018/01/19/1808-drv-usb2/">驱动之USB设备驱动程序</a></li>
</ul>
<p>本文使用 linux-2.6.22.6 内核, 使用jz2440开发板.</p>
<h1 id="触摸屏驱动框架分析"><a href="#触摸屏驱动框架分析" class="headerlink" title="触摸屏驱动框架分析"></a>触摸屏驱动框架分析</h1><h2 id="回顾input子系统"><a href="#回顾input子系统" class="headerlink" title="回顾input子系统"></a>回顾input子系统</h2><p>在 <a href="https://draapho.github.io/2018/01/05/1802-drv-input/">驱动之input子系统</a> 一文里, 已经介绍了input子系统的框架.<br>触摸驱动作为输入设备, 很自然的需要用到input子系统.<br>input子系统, 核心点如下:</p>
<ul>
<li>软件抽象层, <code>/drivers/input/input.c</code> <code>/drviers/input/*dev.c</code><ul>
<li>初始化 <code>input_handler</code> 结构体变量, 负责软件抽象.</li>
<li>提供 <code>input_register_handler</code> 函数</li>
<li>提供 <code>input_register_handle(没有r)</code> 函数</li>
<li>提供 <code>input_register_device</code> 函数</li>
</ul>
</li>
<li>连接层, <code>/drviers/input/*dev.c</code><ul>
<li>初始化 <code>input_handle(没有r)</code> 结构体变量, 负责input系统的软硬层对接</li>
<li>注册此变量 <code>input_register_handle(没有r)</code></li>
<li>当注册handler或者device时, 会自动调用 <code>handler-&gt;connect</code>, 匹配并关联软件抽象层和硬件设备层.</li>
</ul>
</li>
<li>硬件设备层, 需要自己来实现<ul>
<li>负责具体的硬件功能实现.</li>
<li>初始化 <code>input_dev</code> 结构体变量</li>
<li>注册此变量 <code>input_register_device</code></li>
<li>实现硬件相关代码. 上报事件 <code>input_event</code></li>
</ul>
</li>
</ul>
<h2 id="s3c2410的触摸屏框架"><a href="#s3c2410的触摸屏框架" class="headerlink" title="s3c2410的触摸屏框架"></a>s3c2410的触摸屏框架</h2><p>s3c2410的触摸屏框架使用了input层. 硬件设备层又使用了platform框架来进一步隔离硬件上的通用代码和专用参数设置.<br>platform总线系统的详情可查看 <a href="https://draapho.github.io/2018/01/08/1803-drv-platform/">驱动之platform概念</a><br>整个框架层次如下图:</p>
<p><img src="https://draapho.github.io/images/1806/ts.png" alt="ts"></p>
<p>platform 总线框架具体分析如下:</p>
<ul>
<li>platform_driver <code>/drivers/input/touchscreen/s3c2410_ts.c</code><ul>
<li>调用 <code>platform_driver_register(&amp;s3c2410ts_driver);</code></li>
<li>匹配时, 执行 <code>s3c2410ts_probe</code><ul>
<li>和想的不一样, 用的 <code>evbit</code> 而不是 <code>absbit</code></li>
<li><code>ts.dev-&gt;evbit[0] = BIT(EV_SYN) | BIT(EV_KEY) | BIT(EV_ABS);</code></li>
<li><code>ts.dev-&gt;keybit[LONG(BTN_TOUCH)] = BIT(BTN_TOUCH);</code></li>
<li>然后向input系统注册device <code>input_register_device(ts.dev);</code></li>
</ul>
</li>
<li>timer超时函数 <code>touch_timer_fire</code>, 检测和发送触摸事件<ul>
<li><code>input_report_abs</code></li>
<li><code>input_report_key</code></li>
</ul>
</li>
</ul>
</li>
<li>platform_device <code>/arch/arm/plat-s3c24xx/common-smdk.c</code><ul>
<li>调用 <code>platform_add_devices(smdk_devs, ARRAY_SIZE(smdk_devs));</code></li>
<li><code>smdk_devs</code> 里面包含了 <code>s3c_device_ts</code></li>
<li>通过 <code>set_s3c2410ts_info</code> 函数来设置 <code>s3c_device_ts</code></li>
</ul>
</li>
</ul>
<h1 id="测试触摸屏驱动"><a href="#测试触摸屏驱动" class="headerlink" title="测试触摸屏驱动"></a>测试触摸屏驱动</h1><p>这里用的开发板自带的触摸屏驱动, 先测试一下.</p>
<h2 id="方法一-hexdump"><a href="#方法一-hexdump" class="headerlink" title="方法一 hexdump"></a>方法一 hexdump</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 开发板端</span></span><br><span class="line">$ ls /dev/event*</span><br><span class="line"><span class="comment"># 系统自带的一般是 event0, 对应触摸屏事件</span></span><br><span class="line">$ hexdump /dev/event0</span><br><span class="line"><span class="comment"># 字节数|   秒    |   微秒   |type|code|  value       # 小端模式, 低位在前!</span></span><br><span class="line">0000000 04aa 0000 8555 000b 0003 0000 0138 0000     <span class="comment"># input_report_abs(ts.dev, ABS_X, ts.xp);</span></span><br><span class="line">0000010 04aa 0000 8569 000b 0003 0001 020e 0000     <span class="comment"># input_report_abs(ts.dev, ABS_Y, ts.yp);</span></span><br><span class="line">0000020 04aa 0000 856e 000b 0001 014a 0001 0000     <span class="comment"># input_report_key(ts.dev, BTN_TOUCH, 1);</span></span><br><span class="line">0000030 04aa 0000 8570 000b 0003 0018 0001 0000     <span class="comment"># input_report_abs(ts.dev, ABS_PRESSURE, 1);</span></span><br><span class="line">0000040 04aa 0000 8573 000b 0000 0000 0000 0000     <span class="comment"># input_sync(ts.dev);</span></span><br></pre></td></tr></table></figure>

<h2 id="方法二-tslib"><a href="#方法二-tslib" class="headerlink" title="方法二 tslib"></a>方法二 tslib</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Ubuntu 主机端, 需要先编译 tslib</span></span><br><span class="line"><span class="comment"># pwd = ./drivers/ts</span></span><br><span class="line">$ tar xzf tslib-1.4.tar.gz</span><br><span class="line">$ <span class="built_in">cd</span> tslib</span><br><span class="line">$ ./autogen.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 报错: ./autogen.sh: 4: autoreconf: not found</span></span><br><span class="line"><span class="comment"># 报错: configure.ac:25: error: possibly undefined macro: AC_DISABLE_STATIC</span></span><br><span class="line"><span class="comment"># sudo apt-get install autoconf automake libtool # 安装相关软件即可</span></span><br><span class="line"></span><br><span class="line">$ mkdir tmp</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;ac_cv_func_malloc_0_nonnull=yes&quot;</span> &gt;arm-linux.cache</span><br><span class="line">$ ./configure --host=arm-linux --cache-file=arm-linux.cache --prefix=$(<span class="built_in">pwd</span>)/tmp</span><br><span class="line">$ make</span><br><span class="line">$ make install</span><br><span class="line">$ ll tmp/bin                                <span class="comment"># 查看一下编译结果.</span></span><br><span class="line">$ vi tmp/etc/ts.conf</span><br><span class="line"><span class="comment"># ===== 修改第二行 =====</span></span><br><span class="line">    <span class="comment"># module_raw input</span></span><br><span class="line">    <span class="comment"># 取消注释, 改为:</span></span><br><span class="line">    module_raw input</span><br><span class="line"><span class="comment"># ===== wq 保存退出 =====</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 开发板端</span></span><br><span class="line"><span class="comment"># pwd = ./drivers/ts/tslib/tmp              # 挂载的nfs文件系统</span></span><br><span class="line">$ cp * -rf /                                <span class="comment"># 拷贝到根目录</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置环境变量</span></span><br><span class="line">$ <span class="built_in">export</span> TSLIB_TSDEVICE=/dev/event0         <span class="comment"># 必须对应ts的event</span></span><br><span class="line">$ <span class="built_in">export</span> TSLIB_CALIBFILE=/etc/pointercal</span><br><span class="line">$ <span class="built_in">export</span> TSLIB_CONFFILE=/etc/ts.conf</span><br><span class="line">$ <span class="built_in">export</span> TSLIB_PLUGINDIR=/lib/ts</span><br><span class="line">$ <span class="built_in">export</span> TSLIB_CONSOLEDEVICE=none</span><br><span class="line">$ <span class="built_in">export</span> TSLIB_FBDEVICE=/dev/fb0            <span class="comment"># 对应屏幕的framebuffer</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 开始测试</span></span><br><span class="line">$ ts_calibrate                              <span class="comment"># 五点校验</span></span><br><span class="line">xres = 480, yres = 272</span><br><span class="line">Top left :</span><br><span class="line">Top right :</span><br><span class="line">Bot right :</span><br><span class="line">Bot left :</span><br><span class="line">Center :</span><br><span class="line">$ ts_test                                   <span class="comment"># 开始测试</span></span><br><span class="line">时间: X坐标 Y坐标 是否按下</span><br><span class="line">$ ts_print_raw                              <span class="comment"># 打印原始数据</span></span><br><span class="line">时间: X电压值 Y电压值 是否按下</span><br></pre></td></tr></table></figure>

<h1 id="源码-第一版"><a href="#源码-第一版" class="headerlink" title="源码, 第一版"></a>源码, 第一版</h1><p>第一版源码, 让触摸屏工作起来即可</p>
<h2 id="ts-c"><a href="#ts-c" class="headerlink" title="ts.c"></a>ts.c</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/input.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/serio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/delay.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/platform_device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/clk.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/io.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/irq.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/plat-s3c24xx/ts.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/arch/regs-adc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/arch/regs-gpio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">s3c_ts_regs</span> &#123;</span>                                <span class="comment">// 触摸屏寄存器</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> adccon;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> adctsc;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> adcdly;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> adcdat0;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> adcdat1;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> adcupdn;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">input_dev</span> *<span class="title">s3c_ts_dev</span>;</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">volatile</span> <span class="class"><span class="keyword">struct</span> <span class="title">s3c_ts_regs</span> *<span class="title">s3c_ts_regs</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 几个模式的设置</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">enter_wait_pen_down_mode</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    s3c_ts_regs-&gt;adctsc = <span class="number">0xd3</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">enter_wait_pen_up_mode</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    s3c_ts_regs-&gt;adctsc = <span class="number">0x1d3</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">enter_measure_xy_mode</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    s3c_ts_regs-&gt;adctsc = (<span class="number">1</span>&lt;&lt;<span class="number">3</span>)|(<span class="number">1</span>&lt;&lt;<span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">start_adc</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    s3c_ts_regs-&gt;adccon |= (<span class="number">1</span>&lt;&lt;<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 触摸事件中断, 按下或松开触摸屏</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">irqreturn_t</span> <span class="title">pen_down_up_irq</span><span class="params">(<span class="keyword">int</span> irq, <span class="keyword">void</span> *dev_id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (s3c_ts_regs-&gt;adcdat0 &amp; (<span class="number">1</span>&lt;&lt;<span class="number">15</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        printk(<span class="string">&quot;pen up\n&quot;</span>);</span><br><span class="line">        enter_wait_pen_down_mode();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//printk(&quot;pen down\n&quot;);</span></span><br><span class="line">        <span class="comment">//enter_wait_pen_up_mode();</span></span><br><span class="line">        enter_measure_xy_mode();                    <span class="comment">// 按下了, 准备开始测量</span></span><br><span class="line">        start_adc();                                <span class="comment">// 测量adc</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> IRQ_HANDLED;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ADC完成中断</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">irqreturn_t</span> <span class="title">adc_irq</span><span class="params">(<span class="keyword">int</span> irq, <span class="keyword">void</span> *dev_id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> cnt = <span class="number">0</span>;</span><br><span class="line">    printk(<span class="string">&quot;adc_irq cnt = %d, x = %d, y = %d\n&quot;</span>, ++cnt,</span><br><span class="line">        s3c_ts_regs-&gt;adcdat0 &amp; <span class="number">0x3ff</span>, s3c_ts_regs-&gt;adcdat1 &amp; <span class="number">0x3ff</span>);</span><br><span class="line">                                                    <span class="comment">// 打印测量结果</span></span><br><span class="line">    enter_wait_pen_up_mode();</span><br><span class="line">    <span class="keyword">return</span> IRQ_HANDLED;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">s3c_ts_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">clk</span>* <span class="title">clk</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 1. 分配一个input_dev结构体 */</span></span><br><span class="line">    s3c_ts_dev = input_allocate_device();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 2. 设置 */</span></span><br><span class="line">    <span class="comment">/* 2.1 能产生哪类事件 */</span></span><br><span class="line">    set_bit(EV_KEY, s3c_ts_dev-&gt;evbit);             <span class="comment">// 按键事件</span></span><br><span class="line">    set_bit(EV_ABS, s3c_ts_dev-&gt;evbit);             <span class="comment">// 绝对坐标事件</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 2.2 能产生按键事件里的哪些值 */</span></span><br><span class="line">    set_bit(BTN_TOUCH, s3c_ts_dev-&gt;keybit);         <span class="comment">// 键盘的虚拟按键</span></span><br><span class="line"></span><br><span class="line">    input_set_abs_params(s3c_ts_dev, ABS_X, <span class="number">0</span>, <span class="number">0x3FF</span>, <span class="number">0</span>, <span class="number">0</span>);    <span class="comment">// 绝对坐标范围设置</span></span><br><span class="line">    input_set_abs_params(s3c_ts_dev, ABS_Y, <span class="number">0</span>, <span class="number">0x3FF</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    input_set_abs_params(s3c_ts_dev, ABS_PRESSURE, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>); <span class="comment">// 是否按压, 理解为Z轴即可.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 3. 注册 */</span></span><br><span class="line">    input_register_device(s3c_ts_dev);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 4. 硬件相关的操作 */</span></span><br><span class="line">    <span class="comment">/* 4.1 使能时钟(CLKCON[15]) */</span></span><br><span class="line">    clk = clk_get(<span class="literal">NULL</span>, <span class="string">&quot;adc&quot;</span>);</span><br><span class="line">    clk_enable(clk);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 4.2 设置S3C2440的ADC/TS寄存器 */</span></span><br><span class="line">    s3c_ts_regs = ioremap(<span class="number">0x58000000</span>, <span class="keyword">sizeof</span>(struct s3c_ts_regs));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* bit[14]  : 1-A/D converter prescaler enable</span></span><br><span class="line"><span class="comment">     * bit[13:6]: A/D converter prescaler value,</span></span><br><span class="line"><span class="comment">     *            49, ADCCLK=PCLK/(49+1)=50MHz/(49+1)=1MHz</span></span><br><span class="line"><span class="comment">     * bit[0]: A/D conversion starts by enable. 先设为0</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    s3c_ts_regs-&gt;adccon = (<span class="number">1</span>&lt;&lt;<span class="number">14</span>)|(<span class="number">49</span>&lt;&lt;<span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使能两个中断</span></span><br><span class="line">    request_irq(IRQ_TC, pen_down_up_irq, IRQF_SAMPLE_RANDOM, <span class="string">&quot;ts_pen&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">    request_irq(IRQ_ADC, adc_irq, IRQF_SAMPLE_RANDOM, <span class="string">&quot;adc&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    enter_wait_pen_down_mode();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">s3c_ts_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    free_irq(IRQ_TC, <span class="literal">NULL</span>);</span><br><span class="line">    iounmap(s3c_ts_regs);</span><br><span class="line">    input_unregister_device(s3c_ts_dev);</span><br><span class="line">    input_free_device(s3c_ts_dev);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(s3c_ts_init);</span><br><span class="line">module_exit(s3c_ts_exit);</span><br></pre></td></tr></table></figure>

<h2 id="Makefile"><a href="#Makefile" class="headerlink" title="Makefile"></a>Makefile</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">obj-m       := ts.o</span><br><span class="line">KERN_SRC    := /home/draapho/share/jz2440/kernel/linux<span class="number">-2.6</span><span class="number">.22</span><span class="number">.6</span>/</span><br><span class="line">PWD         := $(shell pwd)</span><br><span class="line"></span><br><span class="line">modules:</span><br><span class="line">    make -C $(KERN_SRC) M=$(PWD) modules</span><br><span class="line"></span><br><span class="line">clean:</span><br><span class="line">    make -C $(KERN_SRC) M=$(PWD) clean</span><br></pre></td></tr></table></figure>

<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>由于内核自带了驱动程序, 因此需要重新编译内核, 去掉触摸驱动</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># Ubuntu 主机端</span><br><span class="line"># pwd &#x3D; .&#x2F;linux-2.6.22.6_custom  复制一个新的内核源码目录</span><br><span class="line"></span><br><span class="line">$ make clean</span><br><span class="line">$ make menuconfig                               # 去掉自带的触摸屏驱动程序</span><br><span class="line"># -&gt; Device Drivers</span><br><span class="line">#   -&gt; Input device support</span><br><span class="line">#     -&gt; Touchscreens</span><br><span class="line">#       &lt; &gt; S3C2410&#x2F;S3C2440 touchscreens        # 取消触摸屏驱动</span><br><span class="line"></span><br><span class="line">$ make uImage</span><br><span class="line"># 烧录新的uImage</span><br><span class="line"># 重启开发板进入uboot烧录界面, 按k准备烧录内核. 略过不表</span><br><span class="line">$ sudo dnw .&#x2F;arch&#x2F;arm&#x2F;boot&#x2F;uImage</span><br><span class="line"></span><br><span class="line"># pwd &#x3D; ~&#x2F;share&#x2F;jz2440&#x2F;drivers&#x2F;ts&#x2F;              # 触摸屏驱动目录</span><br><span class="line">$ make modules                                  # 生成ts.ko</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 开发板端</span><br><span class="line"># pwd &#x3D; ~&#x2F;share&#x2F;jz2440&#x2F;drivers&#x2F;ts&#x2F;              # 触摸屏驱动目录, nfs</span><br><span class="line">$ insmod ts.ko                                  # 加载驱动, 开始测试</span><br><span class="line">input: Unspecified device as &#x2F;class&#x2F;input&#x2F;input0</span><br><span class="line">adc_irq cnt &#x3D; 1, x &#x3D; 17, y &#x3D; 991</span><br><span class="line">pen up</span><br><span class="line"># 点击触摸屏, 就会打印出坐标, 释放时, 就会显示 pen up</span><br><span class="line"># 至此, 说明触摸屏的硬件设置没有问题!</span><br></pre></td></tr></table></figure>

<h1 id="源码-第二版"><a href="#源码-第二版" class="headerlink" title="源码, 第二版"></a>源码, 第二版</h1><p>第一版的源码用于检测触摸屏的硬件设置是否正确, 触摸屏是否能正常工作.<br>但在实际情况下, 对触摸屏的ADC值还需要进行软件滤波等工作, 以提高可用性.<br>另外我们去掉了printk的打印信息, 改为 <code>input_report_abs</code> <code>input_report_key</code></p>
<h2 id="ts-c-1"><a href="#ts-c-1" class="headerlink" title="ts.c"></a>ts.c</h2><p>为方便理解, 减少代码量, 和源码第一版相同的部分删掉了.<br>譬如头文件, 小函数等.</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">timer_list</span> <span class="title">ts_timer</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 软件过滤用, 如果4次ADC值的差值过大, 直接丢弃</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">s3c_filter_ts</span><span class="params">(<span class="keyword">int</span> x[], <span class="keyword">int</span> y[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">define</span> ERR_LIMIT 10                                    <span class="comment">// 这是个经验值</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> avr_x, avr_y;</span><br><span class="line">    <span class="keyword">int</span> det_x, det_y;</span><br><span class="line"></span><br><span class="line">    avr_x = (x[<span class="number">0</span>] + x[<span class="number">1</span>])/<span class="number">2</span>;                                <span class="comment">// 获得数据0,1的平均值</span></span><br><span class="line">    avr_y = (y[<span class="number">0</span>] + y[<span class="number">1</span>])/<span class="number">2</span>;</span><br><span class="line">    det_x = (x[<span class="number">2</span>] &gt; avr_x) ? (x[<span class="number">2</span>] - avr_x) : (avr_x - x[<span class="number">2</span>]);<span class="comment">// 求数据2的差值</span></span><br><span class="line">    det_y = (y[<span class="number">2</span>] &gt; avr_y) ? (y[<span class="number">2</span>] - avr_y) : (avr_y - y[<span class="number">2</span>]);</span><br><span class="line">    <span class="keyword">if</span> ((det_x &gt; ERR_LIMIT) || (det_y &gt; ERR_LIMIT))         <span class="comment">// 差值太大, 丢弃整组数据</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    avr_x = (x[<span class="number">1</span>] + x[<span class="number">2</span>])/<span class="number">2</span>;                                <span class="comment">// 获得数据1,2的平均值</span></span><br><span class="line">    avr_y = (y[<span class="number">1</span>] + y[<span class="number">2</span>])/<span class="number">2</span>;</span><br><span class="line">    det_x = (x[<span class="number">3</span>] &gt; avr_x) ? (x[<span class="number">3</span>] - avr_x) : (avr_x - x[<span class="number">3</span>]);<span class="comment">// 求数据3的差值</span></span><br><span class="line">    det_y = (y[<span class="number">3</span>] &gt; avr_y) ? (y[<span class="number">3</span>] - avr_y) : (avr_y - y[<span class="number">3</span>]);</span><br><span class="line">    <span class="keyword">if</span> ((det_x &gt; ERR_LIMIT) || (det_y &gt; ERR_LIMIT))         <span class="comment">// 差值太大, 丢弃整组数据</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定时器, 用去测量触摸屏长按和移动. 在adc中断函数里触发</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">s3c_ts_timer_function</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (s3c_ts_regs-&gt;adcdat0 &amp; (<span class="number">1</span>&lt;&lt;<span class="number">15</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* 已经松开 */</span>                                       <span class="comment">// 向input层报告事件</span></span><br><span class="line">        input_report_abs(s3c_ts_dev, ABS_PRESSURE, <span class="number">0</span>);</span><br><span class="line">        input_report_key(s3c_ts_dev, BTN_TOUCH, <span class="number">0</span>);</span><br><span class="line">        input_sync(s3c_ts_dev);</span><br><span class="line">        enter_wait_pen_down_mode();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* 测量X/Y坐标 */</span></span><br><span class="line">        enter_measure_xy_mode();                            <span class="comment">// 没有松开, 周期性测量</span></span><br><span class="line">        start_adc();                                        <span class="comment">// 触发adc, adc完成后又会触发定时器, 形成周期测量.</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 触摸事件中断, 按下或松开触摸屏</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">irqreturn_t</span> <span class="title">pen_down_up_irq</span><span class="params">(<span class="keyword">int</span> irq, <span class="keyword">void</span> *dev_id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (s3c_ts_regs-&gt;adcdat0 &amp; (<span class="number">1</span>&lt;&lt;<span class="number">15</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//printk(&quot;pen up\n&quot;);                               // 松开, 向input层报告事件</span></span><br><span class="line">        input_report_abs(s3c_ts_dev, ABS_PRESSURE, <span class="number">0</span>);</span><br><span class="line">        input_report_key(s3c_ts_dev, BTN_TOUCH, <span class="number">0</span>);</span><br><span class="line">        input_sync(s3c_ts_dev);</span><br><span class="line">        enter_wait_pen_down_mode();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//printk(&quot;pen down\n&quot;);</span></span><br><span class="line">        <span class="comment">//enter_wait_pen_up_mode();</span></span><br><span class="line">        enter_measure_xy_mode();                            <span class="comment">// 刚按下, 开始测量</span></span><br><span class="line">        start_adc();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> IRQ_HANDLED;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ADC完成中断</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">irqreturn_t</span> <span class="title">adc_irq</span><span class="params">(<span class="keyword">int</span> irq, <span class="keyword">void</span> *dev_id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> x[<span class="number">4</span>], y[<span class="number">4</span>];</span><br><span class="line">    <span class="keyword">int</span> adcdat0, adcdat1;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 优化措施2: 如果ADC完成时, 发现触摸笔已经松开, 则丢弃此次结果 */</span></span><br><span class="line">    adcdat0 = s3c_ts_regs-&gt;adcdat0;</span><br><span class="line">    adcdat1 = s3c_ts_regs-&gt;adcdat1;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (s3c_ts_regs-&gt;adcdat0 &amp; (<span class="number">1</span>&lt;&lt;<span class="number">15</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* 已经松开 */</span></span><br><span class="line">        cnt = <span class="number">0</span>;</span><br><span class="line">        input_report_abs(s3c_ts_dev, ABS_PRESSURE, <span class="number">0</span>);</span><br><span class="line">        input_report_key(s3c_ts_dev, BTN_TOUCH, <span class="number">0</span>);</span><br><span class="line">        input_sync(s3c_ts_dev);</span><br><span class="line">        enter_wait_pen_down_mode();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// printk(&quot;adc_irq cnt = %d, x = %d, y = %d\n&quot;, ++cnt, adcdat0 &amp; 0x3ff, adcdat1 &amp; 0x3ff);</span></span><br><span class="line">        <span class="comment">/* 优化措施3: 多次测量求平均值 */</span></span><br><span class="line">        x[cnt] = adcdat0 &amp; <span class="number">0x3ff</span>;</span><br><span class="line">        y[cnt] = adcdat1 &amp; <span class="number">0x3ff</span>;</span><br><span class="line">        ++cnt;</span><br><span class="line">        <span class="keyword">if</span> (cnt == <span class="number">4</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/* 优化措施4: 软件过滤 */</span></span><br><span class="line">            <span class="keyword">if</span> (s3c_filter_ts(x, y))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//printk(&quot;x = %d, y = %d\n&quot;, (x[0]+x[1]+x[2]+x[3])/4, (y[0]+y[1]+y[2]+y[3])/4);</span></span><br><span class="line">                input_report_abs(s3c_ts_dev, ABS_X, (x[<span class="number">0</span>]+x[<span class="number">1</span>]+x[<span class="number">2</span>]+x[<span class="number">3</span>])/<span class="number">4</span>);</span><br><span class="line">                input_report_abs(s3c_ts_dev, ABS_Y, (y[<span class="number">0</span>]+y[<span class="number">1</span>]+y[<span class="number">2</span>]+y[<span class="number">3</span>])/<span class="number">4</span>);</span><br><span class="line">                input_report_abs(s3c_ts_dev, ABS_PRESSURE, <span class="number">1</span>);</span><br><span class="line">                input_report_key(s3c_ts_dev, BTN_TOUCH, <span class="number">1</span>);</span><br><span class="line">                input_sync(s3c_ts_dev);</span><br><span class="line">            &#125;</span><br><span class="line">            cnt = <span class="number">0</span>;</span><br><span class="line">            enter_wait_pen_up_mode();</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* 启动定时器处理长按/滑动的情况 */</span></span><br><span class="line">            mod_timer(&amp;ts_timer, jiffies + HZ/<span class="number">100</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            enter_measure_xy_mode();</span><br><span class="line">            start_adc();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> IRQ_HANDLED;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">s3c_ts_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ......                          <span class="comment">// 硬件配置都一样, 略过</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使能两个中断</span></span><br><span class="line">    request_irq(IRQ_TC, pen_down_up_irq, IRQF_SAMPLE_RANDOM, <span class="string">&quot;ts_pen&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">    request_irq(IRQ_ADC, adc_irq, IRQF_SAMPLE_RANDOM, <span class="string">&quot;adc&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 优化措施1:</span></span><br><span class="line"><span class="comment">     * 设置ADCDLY为最大值, 这使得电压稳定后再发出IRQ_TC中断</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    s3c_ts_regs-&gt;adcdly = <span class="number">0xffff</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 优化措施5: 使用定时器处理长按,滑动的情况 */</span></span><br><span class="line">    init_timer(&amp;ts_timer);</span><br><span class="line">    ts_timer.function = s3c_ts_timer_function;</span><br><span class="line">    add_timer(&amp;ts_timer);</span><br><span class="line"></span><br><span class="line">    enter_wait_pen_down_mode();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">s3c_ts_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    free_irq(IRQ_TC, <span class="literal">NULL</span>);</span><br><span class="line">    free_irq(IRQ_ADC, <span class="literal">NULL</span>);</span><br><span class="line">    iounmap(s3c_ts_regs);</span><br><span class="line">    input_unregister_device(s3c_ts_dev);</span><br><span class="line">    input_free_device(s3c_ts_dev);</span><br><span class="line">    del_timer(&amp;ts_timer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 先按照此文之前的测试步骤设置好tslib, 烧录无触摸屏驱动的内核文件.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 开发板端</span></span><br><span class="line"><span class="comment"># pwd = ./drivers/ts/                               # 挂载的nfs文件系统</span></span><br><span class="line">$ rmmod ts                                          <span class="comment"># 卸载源码第一版加载的触摸屏驱动</span></span><br><span class="line">$ ls /dev/event*</span><br><span class="line">$ insmod ts.ko                                      <span class="comment"># 加载驱动</span></span><br><span class="line">$ ls /dev/event*</span><br><span class="line"><span class="comment"># 多出的一个event, 就是触摸屏的event, 譬如event0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 方法一, 用hexdump测试</span></span><br><span class="line"></span><br><span class="line">$ hexdump /dev/event0</span><br><span class="line"><span class="comment"># 字节数|   秒    |   微秒   |type|code|  value       # 小端模式, 低位在前!</span></span><br><span class="line">0000000 04aa 0000 8555 000b 0003 0000 0138 0000     <span class="comment"># input_report_abs(ts.dev, ABS_X, ts.xp);</span></span><br><span class="line">0000010 04aa 0000 8569 000b 0003 0001 020e 0000     <span class="comment"># input_report_abs(ts.dev, ABS_Y, ts.yp);</span></span><br><span class="line">0000030 04aa 0000 8570 000b 0003 0018 0001 0000     <span class="comment"># input_report_abs(ts.dev, ABS_PRESSURE, 1);</span></span><br><span class="line">0000020 04aa 0000 856e 000b 0001 014a 0001 0000     <span class="comment"># input_report_key(ts.dev, BTN_TOUCH, 1);</span></span><br><span class="line">0000040 04aa 0000 8573 000b 0000 0000 0000 0000     <span class="comment"># input_sync(ts.dev);</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 方法二, 用tslib测试</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置环境变量</span></span><br><span class="line">$ <span class="built_in">export</span> TSLIB_TSDEVICE=/dev/event0         <span class="comment"># 必须对应ts的event</span></span><br><span class="line">$ <span class="built_in">export</span> TSLIB_CALIBFILE=/etc/pointercal</span><br><span class="line">$ <span class="built_in">export</span> TSLIB_CONFFILE=/etc/ts.conf</span><br><span class="line">$ <span class="built_in">export</span> TSLIB_PLUGINDIR=/lib/ts</span><br><span class="line">$ <span class="built_in">export</span> TSLIB_CONSOLEDEVICE=none</span><br><span class="line">$ <span class="built_in">export</span> TSLIB_FBDEVICE=/dev/fb0            <span class="comment"># 对应屏幕的framebuffer</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 开始测试</span></span><br><span class="line">$ ts_calibrate                              <span class="comment"># 五点校验</span></span><br><span class="line">xres = 480, yres = 272</span><br><span class="line">Top left :</span><br><span class="line">Top right :</span><br><span class="line">Bot right :</span><br><span class="line">Bot left :</span><br><span class="line">Center :</span><br><span class="line">$ ts_test                                   <span class="comment"># 开始测试</span></span><br><span class="line">时间: X坐标 Y坐标 是否按下</span><br><span class="line">$ ts_print_raw                              <span class="comment"># 打印原始数据</span></span><br><span class="line">时间: X电压值 Y电压值 是否按下</span><br></pre></td></tr></table></figure>

<hr>
<p><em><strong>原创于 <a href="https://draapho.github.io/">DRA&amp;PHO</a></strong></em></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/embedded-linux/" rel="tag"># embedded linux</a>
              <a href="/tags/driver/" rel="tag"># driver</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2018/01/10/1805-interview-general/" rel="prev" title="面试之常规问题">
                  <i class="fa fa-chevron-left"></i> 面试之常规问题
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2018/01/18/1807-drv-usb1/" rel="next" title="驱动之USB基础概念和框架">
                  驱动之USB基础概念和框架 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>







<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">draapho</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  
<script src="/js/local-search.js"></script>






  





</body>
</html>
