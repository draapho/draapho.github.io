<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon_32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon_16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.2/css/all.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"draapho.github.io","root":"/","images":"/images","scheme":"Mist","version":"8.2.2","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}};
  </script>
<meta name="description" content="如题.">
<meta property="og:type" content="article">
<meta property="og:title" content="python基础： 深入理解 python 中的赋值、引用、拷贝、作用域">
<meta property="og:url" content="https://draapho.github.io/2016/11/21/1618-python-variable/index.html">
<meta property="og:site_name" content="DRA&amp;PHO">
<meta property="og:description" content="如题.">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://draapho.github.io/images/1618/python_point_1.jpg">
<meta property="og:image" content="https://draapho.github.io/images/1618/python_point_2.jpg">
<meta property="og:image" content="https://draapho.github.io/images/1618/python_point_3.jpg">
<meta property="og:image" content="https://draapho.github.io/images/1618/python_point_4.jpg">
<meta property="og:image" content="https://draapho.github.io/images/1618/python_point_5.jpg">
<meta property="og:image" content="https://draapho.github.io/images/1618/python_point_6.jpg">
<meta property="article:published_time" content="2016-11-20T13:00:00.000Z">
<meta property="article:modified_time" content="2021-05-27T11:42:13.713Z">
<meta property="article:author" content="draapho">
<meta property="article:tag" content="python">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://draapho.github.io/images/1618/python_point_1.jpg">


<link rel="canonical" href="https://draapho.github.io/2016/11/21/1618-python-variable/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>
<title>python基础： 深入理解 python 中的赋值、引用、拷贝、作用域 | DRA&PHO</title>
  




  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">DRA&PHO</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">thinking & logging</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#python%E7%9A%84%E8%B5%8B%E5%80%BC"><span class="nav-number">1.</span> <span class="nav-text">python的赋值</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%88%E6%9D%A5%E7%9C%8B%E4%B8%AA%E9%97%AE%E9%A2%98%E5%90%A7%EF%BC%9A"><span class="nav-number">2.</span> <span class="nav-text">先来看个问题吧：</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E4%B8%AA%E8%B5%8B%E5%80%BC%E9%97%AE%E9%A2%98"><span class="nav-number">2.1.</span> <span class="nav-text">一个赋值问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%85%E5%A4%8D%E5%88%B6%E5%8F%8A%E5%85%B6%E9%A3%8E%E9%99%A9"><span class="nav-number">2.2.</span> <span class="nav-text">浅复制及其风险</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B7%B1%E5%A4%8D%E5%88%B6"><span class="nav-number">2.3.</span> <span class="nav-text">深复制</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%BC%95%E7%94%A8-VS-%E6%8B%B7%E8%B4%9D%EF%BC%9A"><span class="nav-number">3.</span> <span class="nav-text">引用 VS 拷贝：</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%A2%9E%E5%BC%BA%E8%B5%8B%E5%80%BC%E4%BB%A5%E5%8F%8A%E5%85%B1%E4%BA%AB%E5%BC%95%E7%94%A8%EF%BC%9A"><span class="nav-number">4.</span> <span class="nav-text">增强赋值以及共享引用：</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#python-%E4%BB%8E-2k-%E5%88%B0-3k%EF%BC%8C%E8%AF%AD%E5%8F%A5%E5%8F%98%E5%87%BD%E6%95%B0%E5%BC%95%E5%8F%91%E7%9A%84%E5%8F%98%E9%87%8F%E4%BD%9C%E7%94%A8%E5%9F%9F%E9%97%AE%E9%A2%98"><span class="nav-number">5.</span> <span class="nav-text">python 从 2k 到 3k，语句变函数引发的变量作用域问题</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-python-%E5%8F%98%E9%87%8F%E4%BD%9C%E7%94%A8%E5%9F%9F%E5%8F%8A%E5%85%B6%E9%99%B7%E9%98%B1"><span class="nav-number">6.</span> <span class="nav-text">深入理解 python 变量作用域及其陷阱</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%AF%E5%8F%98%E5%AF%B9%E8%B1%A1-amp-%E4%B8%8D%E5%8F%AF%E5%8F%98%E5%AF%B9%E8%B1%A1"><span class="nav-number">6.1.</span> <span class="nav-text">可变对象 &amp; 不可变对象</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%BD%E6%95%B0%E5%80%BC%E4%BC%A0%E9%80%92"><span class="nav-number">6.2.</span> <span class="nav-text">函数值传递</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BF%AE%E6%94%B9%E5%85%A8%E5%B1%80%E7%9A%84dict%E5%8F%98%E9%87%8F%E4%B8%8D%E7%94%A8global%E5%85%B3%E9%94%AE%E5%AD%97"><span class="nav-number">6.3.</span> <span class="nav-text">为什么修改全局的dict变量不用global关键字</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%AF%E5%8F%98%E5%AF%B9%E8%B1%A1-list-%E7%9A%84-%E5%92%8C-append-extend-%E5%B7%AE%E5%88%AB%E5%9C%A8%E5%93%AA%EF%BC%9F"><span class="nav-number">6.4.</span> <span class="nav-text">可变对象 list 的 &#x3D; 和 append&#x2F;extend 差别在哪？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%99%B7%E9%98%B1%EF%BC%9A%E4%BD%BF%E7%94%A8%E5%8F%AF%E5%8F%98%E7%9A%84%E9%BB%98%E8%AE%A4%E5%8F%82%E6%95%B0"><span class="nav-number">6.5.</span> <span class="nav-text">陷阱：使用可变的默认参数</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#REF%EF%BC%9A"><span class="nav-number">7.</span> <span class="nav-text">REF：</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="draapho"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">draapho</p>
  <div class="site-description" itemprop="description">explore</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">138</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">85</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://draapho.github.io/2016/11/21/1618-python-variable/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="draapho">
      <meta itemprop="description" content="explore">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="DRA&PHO">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          python基础： 深入理解 python 中的赋值、引用、拷贝、作用域
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2016-11-21 00:00:00" itemprop="dateCreated datePublished" datetime="2016-11-21T00:00:00+11:00">2016-11-21</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2021-05-27 21:42:13" itemprop="dateModified" datetime="2021-05-27T21:42:13+10:00">2021-05-27</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a>
        </span>
    </span>

  
</div>

            <div class="post-description">如题.</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p><em><strong>转载自 <a target="_blank" rel="noopener" href="https://my.oschina.net/leejun2005/blog/145911">python基础（5）：深入理解 python 中的赋值、引用、拷贝、作用域</a></strong></em></p>
<hr>
<h1 id="python的赋值"><a href="#python的赋值" class="headerlink" title="python的赋值"></a>python的赋值</h1><p>在 python 中赋值语句总是建立对象的引用值，而不是复制对象。因此，python 变量更像是指针，而不是数据存储区域，<br><img src="https://draapho.github.io/images/1618/python_point_1.jpg" alt="python_point"><br>这点和大多数 OO 语言类似吧，比如 C++、java 等 ~</p>
<h1 id="先来看个问题吧："><a href="#先来看个问题吧：" class="headerlink" title="先来看个问题吧："></a>先来看个问题吧：</h1><h2 id="一个赋值问题"><a href="#一个赋值问题" class="headerlink" title="一个赋值问题"></a>一个赋值问题</h2><p>在Python中，令<code>values=[0,1,2];values[1]=values</code>,为何结果是<code>[0,[...],2]</code>? <a target="_blank" rel="noopener" href="http://www.zhihu.com/question/21000872">链接</a></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>values = [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>values[<span class="number">1</span>] = values</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>values</span><br><span class="line">[<span class="number">0</span>, [...], <span class="number">2</span>]       <span class="comment"># 实际结果, 为何要赋值无限次?</span></span><br><span class="line">[<span class="number">0</span>, [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>], <span class="number">2</span>]   <span class="comment"># 预想结果</span></span><br></pre></td></tr></table></figure>

<p>可以说 Python 没有赋值，只有引用。你这样相当于创建了一个引用自身的结构，所以导致了无限循环。为了理解这个问题，有个基本概念需要搞清楚。</p>
<p>Python 没有「变量」，我们平时所说的变量其实只是「标签」，是引用。</p>
<p>执行 <code>values = [0, 1, 2]</code> 的时候，Python 做的事情是首先创建一个列表对象 [0, 1, 2]，然后给它贴上名为 values 的标签。</p>
<p>如果随后又执行 <code>values = [3, 4, 5]</code> 的话，Python 做的事情是创建另一个列表对象 [3, 4, 5]，然后把刚才那张名为 values 的标签从前面的 [0, 1, 2] 对象上撕下来，重新贴到 [3, 4, 5] 这个对象上。</p>
<p>至始至终，并没有一个叫做 values 的列表对象容器存在，Python 也没有把任何对象的值复制进 values 去。过程如图所示：</p>
<p><img src="https://draapho.github.io/images/1618/python_point_2.jpg" alt="python_point"></p>
<p>执行 <code>values[1] = values</code> 的时候，Python 做的事情则是把 values 这个标签所引用的列表对象的第二个元素指向 values 所引用的列表对象本身。执行完毕后，values 标签还是指向原来那个对象，只不过那个对象的结构发生了变化，从之前的列表 [0, 1, 2] 变成了 [0, ?, 2]，而这个 ? 则是指向那个对象本身的一个引用。如图所示：</p>
<p><img src="https://draapho.github.io/images/1618/python_point_3.jpg" alt="python_point"></p>
<h2 id="浅复制及其风险"><a href="#浅复制及其风险" class="headerlink" title="浅复制及其风险"></a>浅复制及其风险</h2><p>要达到你所需要的效果，即得到 [0, [0, 1, 2], 2] 这个对象，你不能直接将 values[1] 指向 values 引用的对象本身，而是需要吧 [0, 1, 2] 这个对象「复制」一遍，得到一个新对象，再将 values[1] 指向这个复制后的对象。Python 里面复制对象的操作因对象类型而异，复制列表 values 的操作是</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">values[:] <span class="comment">#生成对象的拷贝或者是复制序列，不再是引用和共享变量，但此法只能顶层复制</span></span><br></pre></td></tr></table></figure>

<p>所以你需要执行 <code>values[1] = values[:]</code></p>
<p>Python 做的事情是，先 dereference 得到 values 所指向的对象 [0, 1, 2]，然后执行 [0, 1, 2][:] 复制操作得到一个新的对象，内容也是 [0, 1, 2]，然后将 values 所指向的列表对象的第二个元素指向这个复制二来的列表对象，最终 values 指向的对象是 [0, [0, 1, 2], 2]。过程如图所示：</p>
<p><img src="https://draapho.github.io/images/1618/python_point_4.jpg" alt="python_point"></p>
<p>往更深处说，values[:] 复制操作是所谓的「浅复制」(shallow copy)，当列表对象有嵌套的时候也会产生出乎意料的错误，比如为何要赋值无限次</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a = [<span class="number">0</span>, [<span class="number">1</span>, <span class="number">2</span>], <span class="number">3</span>]</span><br><span class="line">b = a[:]</span><br><span class="line">a[<span class="number">0</span>] = <span class="number">8</span></span><br><span class="line">a[<span class="number">1</span>][<span class="number">1</span>] = <span class="number">9</span></span><br></pre></td></tr></table></figure>
<p>问：此时 a 和 b 分别是多少？</p>
<p>正确答案是 a 为 [8, [1, 9], 3]，b 为 [0, [1, 9], 3]。发现没？b 的第二个元素也被改变了。想想是为什么？不明白的话看下图</p>
<p><img src="https://draapho.github.io/images/1618/python_point_5.jpg" alt="python_point"></p>
<h2 id="深复制"><a href="#深复制" class="headerlink" title="深复制"></a>深复制</h2><p>正确的复制嵌套元素的方法是进行「深复制」(deep copy)，方法是</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> copy</span><br><span class="line"></span><br><span class="line">a = [<span class="number">0</span>, [<span class="number">1</span>, <span class="number">2</span>], <span class="number">3</span>]</span><br><span class="line">b = copy.deepcopy(a)</span><br><span class="line">a[<span class="number">0</span>] = <span class="number">8</span></span><br><span class="line">a[<span class="number">1</span>][<span class="number">1</span>] = <span class="number">9</span></span><br></pre></td></tr></table></figure>

<p><img src="https://draapho.github.io/images/1618/python_point_6.jpg" alt="python_point"></p>
<h1 id="引用-VS-拷贝："><a href="#引用-VS-拷贝：" class="headerlink" title="引用 VS 拷贝："></a>引用 VS 拷贝：</h1><ul>
<li>没有限制条件的分片表达式（L[:]）能够复制序列，但此法只能浅层复制。</li>
<li>字典 copy 方法，D.copy() 能够复制字典，但此法只能浅层复制</li>
<li>有些内置函数，例如 list，能够生成拷贝 list(L)</li>
<li>copy 标准库模块能够生成完整拷贝：deepcopy 本质上是递归 copy</li>
<li>对于不可变对象和可变对象来说，浅复制都是复制的引用，只是因为复制不变对象和复制不变对象的引用是等效的（因为对象不可变，当改变时会新建对象重新赋值）。所以看起来浅复制只复制不可变对象（整数，实数，字符串等），对于可变对象，浅复制其实是创建了一个对于该对象的引用，也就是说只是给同一个对象贴上了另一个标签而已。</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">L = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line">D = &#123;<span class="string">&#x27;a&#x27;</span>:<span class="number">1</span>, <span class="string">&#x27;b&#x27;</span>:<span class="number">2</span>&#125;</span><br><span class="line">A = L[:]</span><br><span class="line">B = D.copy()</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;L, D&quot;</span></span><br><span class="line"><span class="built_in">print</span>  L, D</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;A, B&quot;</span></span><br><span class="line"><span class="built_in">print</span> A, B</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;--------------------&quot;</span></span><br><span class="line">A[<span class="number">1</span>] = <span class="string">&#x27;NI&#x27;</span></span><br><span class="line">B[<span class="string">&#x27;c&#x27;</span>] = <span class="string">&#x27;spam&#x27;</span></span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;L, D&quot;</span></span><br><span class="line"><span class="built_in">print</span>  L, D</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;A, B&quot;</span></span><br><span class="line"><span class="built_in">print</span> A, B</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">L, D</span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>] &#123;<span class="string">&#x27;a&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;b&#x27;</span>: <span class="number">2</span>&#125;</span><br><span class="line">A, B</span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>] &#123;<span class="string">&#x27;a&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;b&#x27;</span>: <span class="number">2</span>&#125;</span><br><span class="line">--------------------</span><br><span class="line">L, D</span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>] &#123;<span class="string">&#x27;a&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;b&#x27;</span>: <span class="number">2</span>&#125;</span><br><span class="line">A, B</span><br><span class="line">[<span class="number">1</span>, <span class="string">&#x27;NI&#x27;</span>, <span class="number">3</span>] &#123;<span class="string">&#x27;a&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;c&#x27;</span>: <span class="string">&#x27;spam&#x27;</span>, <span class="string">&#x27;b&#x27;</span>: <span class="number">2</span>&#125;</span><br></pre></td></tr></table></figure>

<h1 id="增强赋值以及共享引用："><a href="#增强赋值以及共享引用：" class="headerlink" title="增强赋值以及共享引用："></a>增强赋值以及共享引用：</h1><p>x = x + y，x 出现两次，必须执行两次，性能不好，合并必须新建对象 x，然后复制两个列表合并</p>
<p>属于复制/拷贝</p>
<p>x += y，x 只出现一次，也只会计算一次，性能好，不生成新对象，只在内存块末尾增加元素。</p>
<p>当 x、y 为list时， += 会自动调用 extend 方法进行合并运算，in-place change。</p>
<p>属于共享引用</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">L = [<span class="number">1</span>, <span class="number">2</span>]</span><br><span class="line">M = L</span><br><span class="line">L = L + [<span class="number">3</span>, <span class="number">4</span>]</span><br><span class="line"><span class="built_in">print</span> L, M</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;-------------------&quot;</span></span><br><span class="line">L = [<span class="number">1</span>, <span class="number">2</span>]</span><br><span class="line">M = L</span><br><span class="line">L += [<span class="number">3</span>, <span class="number">4</span>]</span><br><span class="line"><span class="built_in">print</span> L, M</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>] [<span class="number">1</span>, <span class="number">2</span>]</span><br><span class="line">-------------------</span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>] [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]</span><br></pre></td></tr></table></figure>

<h1 id="python-从-2k-到-3k，语句变函数引发的变量作用域问题"><a href="#python-从-2k-到-3k，语句变函数引发的变量作用域问题" class="headerlink" title="python 从 2k 到 3k，语句变函数引发的变量作用域问题"></a>python 从 2k 到 3k，语句变函数引发的变量作用域问题</h1><p>先看段代码：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span>():</span></span><br><span class="line">    a = <span class="literal">False</span></span><br><span class="line">    <span class="built_in">exec</span> (<span class="string">&quot;a = True&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span> (<span class="string">&quot;a = &quot;</span>, a)</span><br><span class="line">test()</span><br><span class="line"></span><br><span class="line">b = <span class="literal">False</span></span><br><span class="line"><span class="built_in">exec</span> (<span class="string">&quot;b = True&quot;</span>)</span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;b = &quot;</span>, b)</span><br></pre></td></tr></table></figure>

<p>在 python 2k 和 3k 下 你会发现他们的结果不一样：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">2K：</span><br><span class="line">a =  <span class="literal">True</span></span><br><span class="line">b =  <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">3K：</span><br><span class="line">a =  <span class="literal">False</span></span><br><span class="line">b =  <span class="literal">True</span></span><br></pre></td></tr></table></figure>

<p>这是为什么呢？</p>
<p>因为 3k 中 exec 由语句变成函数了，而在函数中变量默认都是局部的，也就是说<br>你所见到的两个 a，是两个不同的变量，分别处于不同的命名空间中，而不会冲突。</p>
<p>具体参考 《learning python》P331-P332</p>
<p>知道原因了，我们可以这么改改：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span>():</span></span><br><span class="line">    a = <span class="literal">False</span></span><br><span class="line">    ldict = <span class="built_in">locals</span>()</span><br><span class="line">    exec(<span class="string">&quot;a=True&quot;</span>,<span class="built_in">globals</span>(),ldict)</span><br><span class="line">    a = ldict[<span class="string">&#x27;a&#x27;</span>]</span><br><span class="line">    print(a)</span><br><span class="line"></span><br><span class="line">test()</span><br><span class="line"></span><br><span class="line">b = <span class="literal">False</span></span><br><span class="line">exec(<span class="string">&quot;b = True&quot;</span>, <span class="built_in">globals</span>())</span><br><span class="line">print(<span class="string">&quot;b = &quot;</span>, b)</span><br></pre></td></tr></table></figure>

<p>这是一个典型的 python 2k 移植到 3k 不兼容的案例，类似的还有很多，也算是移植的坑吧~</p>
<p>具体的 2k 与 3k 有哪些差异可以看这里： <a target="_blank" rel="noopener" href="http://woodpecker.org.cn/diveintopython3/porting-code-to-python-3-with-2to3.html"><strong>使用 2to3 将代码移植到 Python 3</strong></a></p>
<h1 id="深入理解-python-变量作用域及其陷阱"><a href="#深入理解-python-变量作用域及其陷阱" class="headerlink" title="深入理解 python 变量作用域及其陷阱"></a>深入理解 python 变量作用域及其陷阱</h1><h2 id="可变对象-amp-不可变对象"><a href="#可变对象-amp-不可变对象" class="headerlink" title="可变对象 &amp; 不可变对象"></a>可变对象 &amp; 不可变对象</h2><ul>
<li>在Python中，对象分为两种：可变对象和不可变对象，</li>
<li>不可变对象包括int，float，long，str，tuple等，可变对象包括list，set，dict等。</li>
<li>需要注意的是：这里说的不可变指的是值的不可变。对于不可变类型的变量，如果要更改变量，则会创建一个新值，把变量绑定到新值上，而旧值如果没有被引用就等待垃圾回收。另外，不可变的类型可以计算hash值，作为字典的key。</li>
<li>可变类型数据对对象操作的时候，不需要再在其他地方申请内存，只需要在此对象后面连续申请(+/-)即可，也就是它的内存地址会保持不变，但区域会变长或者变短。</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = <span class="string">&#x27;xianglong.me&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">id</span>(a)</span><br><span class="line"><span class="number">140443303134352</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = <span class="string">&#x27;1saying.com&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">id</span>(a)</span><br><span class="line"><span class="number">140443303131776</span></span><br><span class="line"><span class="comment"># 重新赋值之后，变量a的内存地址已经变了</span></span><br><span class="line"><span class="comment"># &#x27;xianglong.me&#x27;是str类型，不可变，所以赋值操作知识重新创建了str &#x27;1saying.com&#x27;对象，然后将变量a指向了它</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a_list = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">id</span>(a_list)</span><br><span class="line"><span class="number">140443302951680</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a_list.append(<span class="number">4</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">id</span>(a_list)</span><br><span class="line"><span class="number">140443302951680</span></span><br><span class="line"><span class="comment"># list重新赋值之后，变量a_list的内存地址并未改变</span></span><br><span class="line"><span class="comment"># [1, 2, 3]是可变的，append操作只是改变了其value，变量a_list指向没有变</span></span><br></pre></td></tr></table></figure>

<h2 id="函数值传递"><a href="#函数值传递" class="headerlink" title="函数值传递"></a>函数值传递</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func_int</span>(<span class="params">a</span>):</span></span><br><span class="line">    a += <span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func_list</span>(<span class="params">a_list</span>):</span></span><br><span class="line">    a_list[<span class="number">0</span>] = <span class="number">4</span></span><br><span class="line"></span><br><span class="line">t = <span class="number">0</span></span><br><span class="line">func_int(t)</span><br><span class="line"><span class="built_in">print</span> t</span><br><span class="line"><span class="comment"># output: 0</span></span><br><span class="line"></span><br><span class="line">t_list = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line">func_list(t_list)</span><br><span class="line"><span class="built_in">print</span> t_list</span><br><span class="line"><span class="comment"># output: [4, 2, 3]</span></span><br></pre></td></tr></table></figure>

<p>对于上面的输出，不少Python初学者都比较疑惑：第一个例子看起来像是传值，而第二个例子确实传引用。其实，解释这个问题也非常容易，主要是因为可变对象和不可变对象的原因：对于可变对象，对象的操作不会重建对象，而对于不可变对象，每一次操作就重建新的对象。</p>
<p>在函数参数传递的时候，Python其实就是把参数里传入的变量对应的对象的引用依次赋值给对应的函数内部变量。参照上面的例子来说明更容易理解，func_int中的局部变量”a”其实是全部变量”t”所指向对象的另一个引用，由于整数对象是不可变的，所以当func_int对变量”a”进行修改的时候，实际上是将局部变量”a”指向到了整数对象”1”。所以很明显，func_list修改的是一个可变的对象，局部变量”a”和全局变量”t_list”指向的还是同一个对象。</p>
<h2 id="为什么修改全局的dict变量不用global关键字"><a href="#为什么修改全局的dict变量不用global关键字" class="headerlink" title="为什么修改全局的dict变量不用global关键字"></a>为什么修改全局的dict变量不用global关键字</h2><p>为什么修改字典d的值不用global关键字先声明呢？</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">s = <span class="string">&#x27;foo&#x27;</span></span><br><span class="line">d = &#123;<span class="string">&#x27;a&#x27;</span>:<span class="number">1</span>&#125;</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f</span>():</span></span><br><span class="line">    s = <span class="string">&#x27;bar&#x27;</span></span><br><span class="line">    d[<span class="string">&#x27;b&#x27;</span>] = <span class="number">2</span></span><br><span class="line">f()</span><br><span class="line"><span class="built_in">print</span> s  <span class="comment"># foo</span></span><br><span class="line"><span class="built_in">print</span> d  <span class="comment"># &#123;&#x27;a&#x27;: 1, &#x27;b&#x27;: 2&#125;</span></span><br></pre></td></tr></table></figure>

<p>这是因为，在s = ‘bar’这句中，它是“有歧义的“，因为它既可以是表示引用全局变量s，也可以是创建一个新的局部变量，所以在python中，默认它的行为是创建局部变量，除非显式声明global，global定义的本地变量会变成其对应全局变量的一个别名，即是同一个变量。</p>
<p>在d[‘b’]=2这句中，它是“明确的”，因为如果把d当作是局部变量的话，它会报KeyError，所以它只能是引用全局的d,故不需要多此一举显式声明global。</p>
<p>上面这两句赋值语句其实是不同的行为，一个是<strong>rebinding（不可变对象）</strong>, 一个是<strong>mutation（可变对象）</strong>.</p>
<p>但是如果是下面这样：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">d = &#123;<span class="string">&#x27;a&#x27;</span>:<span class="number">1</span>&#125;</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f</span>():</span></span><br><span class="line">    d = &#123;&#125;</span><br><span class="line">    d[<span class="string">&#x27;b&#x27;</span>] = <span class="number">2</span></span><br><span class="line">f()</span><br><span class="line"><span class="built_in">print</span> d  <span class="comment"># &#123;&#x27;a&#x27;: 1&#125;</span></span><br></pre></td></tr></table></figure>

<p>在d = {}这句，它是”有歧义的“了，所以它是创建了局部变量d，而不是引用全局变量d，所以d[‘b’]=2也是操作的局部变量。</p>
<p>推而远之，这一切现象的本质就是”它是否是明确的“。</p>
<p>仔细想想，就会发现不止dict不需要global，所有”明确的“东西都不需要global。因为int类型str类型之类的不可变对象，每一次操作就重建新的对象，他们只有一种修改方法，即x = y， 恰好这种修改方法同时也是创建变量的方法，所以产生了歧义，不知道是要修改还是创建。而dict/list/对象等可变对象，操作不会重建对象，可以通过dict[‘x’]=y或list.append()之类的来修改，跟创建变量不冲突，不产生歧义，所以都不用显式global。</p>
<h2 id="可变对象-list-的-和-append-extend-差别在哪？"><a href="#可变对象-list-的-和-append-extend-差别在哪？" class="headerlink" title="可变对象 list 的 = 和 append/extend 差别在哪？"></a>可变对象 list 的 = 和 append/extend 差别在哪？</h2><p>接上面 5.3 的理论，下面咱们再看一例常见的错误：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="comment"># 测试utf-8编码</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">reload(sys)</span><br><span class="line">sys.setdefaultencoding(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line">list_a = []</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">a</span>():</span></span><br><span class="line">    list_a = [<span class="number">1</span>]      <span class="comment">## 语句1</span></span><br><span class="line">a()</span><br><span class="line"><span class="built_in">print</span> list_a    <span class="comment"># []</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;======================&quot;</span></span><br><span class="line"></span><br><span class="line">list_b = []</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">b</span>():</span></span><br><span class="line">    list_b.append(<span class="number">1</span>)    <span class="comment">## 语句2</span></span><br><span class="line">b()</span><br><span class="line"><span class="built_in">print</span> list_b    <span class="comment"># [1]</span></span><br></pre></td></tr></table></figure>

<p>大家可以看到为什么 语句1 不能改变 list_a 的值，而 语句2 却可以？他们的差别在哪呢？</p>
<p><strong>因为 = 创建了局部变量，而 .append() 或者 .extend() 重用了全局变量。</strong></p>
<h2 id="陷阱：使用可变的默认参数"><a href="#陷阱：使用可变的默认参数" class="headerlink" title="陷阱：使用可变的默认参数"></a>陷阱：使用可变的默认参数</h2><p>我多次见到过如下的代码：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span>(<span class="params">a, b, c=[]</span>):</span></span><br><span class="line"><span class="comment"># append to c</span></span><br><span class="line"><span class="comment"># do some more stuff</span></span><br></pre></td></tr></table></figure>

<p>永远不要使用可变的默认参数，可以使用如下的代码代替：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span>(<span class="params">a, b, c=<span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="keyword">if</span> c <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        c = []</span><br><span class="line">    <span class="comment"># append to c</span></span><br><span class="line">    <span class="comment"># do some more stuff</span></span><br></pre></td></tr></table></figure>

<p>‍‍与其解释这个问题是什么，不如展示下使用可变默认参数的影响：‍‍</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In[<span class="number">2</span>]: <span class="function"><span class="keyword">def</span> <span class="title">foo</span>(<span class="params">a, b, c=[]</span>):</span></span><br><span class="line"><span class="meta">... </span>       c.append(a)</span><br><span class="line"><span class="meta">... </span>       c.append(b)</span><br><span class="line"><span class="meta">... </span>       print(c)</span><br><span class="line">...</span><br><span class="line">In[<span class="number">3</span>]: foo(<span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">[<span class="number">1</span>, <span class="number">1</span>]</span><br><span class="line">In[<span class="number">4</span>]: foo(<span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">[<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>]</span><br><span class="line">In[<span class="number">5</span>]: foo(<span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">[<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>]</span><br></pre></td></tr></table></figure>

<p>同一个变量c在函数调用的每一次都被反复引用。这可能有一些意想不到的后果。</p>
<h1 id="REF："><a href="#REF：" class="headerlink" title="REF："></a>REF：</h1><ul>
<li><a target="_blank" rel="noopener" href="http://www.zhihu.com/question/21000872/answer/16856382">《learning python》：P130、P134、P202、P204 、P245</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.segmentfault.com/sunisdown/1190000000640834">理解 Python 的 LEGB</a></li>
<li><a target="_blank" rel="noopener" href="http://cenalulu.github.io/python/default-mutable-arguments/">Python函数参数默认值的陷阱和原理深究</a></li>
<li><a target="_blank" rel="noopener" href="http://python.jobbole.com/81564/">潜在的Python陷阱</a></li>
<li><a target="_blank" rel="noopener" href="http://segmentfault.com/a/1190000000743526">陷阱！python参数默认值</a></li>
<li><a target="_blank" rel="noopener" href="http://xianglong.me/article/python-variable-quote-copy-and-scope/">Python中的变量、引用、拷贝和作用域</a></li>
<li><a target="_blank" rel="noopener" href="http://www.cnblogs.com/wanxsb/archive/2013/05/07/3064783.html">Python入门基础知识(1) :locals() 和globals()</a></li>
<li><a target="_blank" rel="noopener" href="http://bit.ly/29vnLvz">Python程序员写代码时应该避免的16个“坑”</a></li>
</ul>
<hr>
<p><em><strong>转载自 <a target="_blank" rel="noopener" href="https://my.oschina.net/leejun2005/blog/145911">python基础（5）：深入理解 python 中的赋值、引用、拷贝、作用域</a></strong></em></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/python/" rel="tag"># python</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2016/11/16/1617-python-terminal/" rel="prev" title="python的第一个小程序, 蓝牙及串口终端">
                  <i class="fa fa-chevron-left"></i> python的第一个小程序, 蓝牙及串口终端
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2016/11/22/1619-python-tips/" rel="next" title="30 个有关 Python 的小技巧">
                  30 个有关 Python 的小技巧 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>







<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">draapho</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  
<script src="/js/local-search.js"></script>






  





</body>
</html>
